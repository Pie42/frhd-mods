// ==UserScript==
// @name         reference image tool
// @version      0.1
// @description  for reference images in track space
// @author       pie42
// @match        https://freerider.app/
// @grant        none
// ==/UserScript==


(y => T => H => (u => U => R => (O => V => q => L => V(_ => T(GameManager && GameManager.game)(_ => q((g => e => (h => t => (v => (o => p => c => C => d => (D => I => (E => (F => (G => (P => q(h.toolHandler.registerTool(P))(d = h.toolHandler.tools.tracing)(c(O('tag')('style')('parent')(document.head)('innerHTML')(".editorgui_icons-icon_tracing " + JSON.stringify(O('background-image')('url("#")')('width')('44px')('height')('44px')('background-size')('34px')('background-position')('5px')()).replaceAll(...L(/[+-\-]/g)(a => T(a == '-' || a == '+')(_ => a)(_ => String.fromCharCode(a.charCodeAt(0)+15)))()).replaceAll(...L(/(?<!\\)"/g)("")()).replaceAll(...L('\\')('')()).replace(...L('#')(atob("ZGF0YTppbWFnZS9zdmcreG1sLCUzQyUzRnhtbCB2ZXJzaW9uPScxLjAnIGVuY29kaW5nPSd1dGYtOCclM0YlM0UlM0MhLS0gVXBsb2FkZWQgdG86IFNWRyBSZXBvLCB3d3cuc3ZncmVwby5jb20gR2VuZXJhdG9yOiBTVkcgUmVwbyBNaXhlciBUb29scyAtLSUzRSUzQ3N2ZyB3aWR0aD0nODAwcHgnIGhlaWdodD0nODAwcHgnIHZpZXdCb3g9JzAgMCAyNCAyNCcgZmlsbD0nbm9uZScgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ3BhdGggZmlsbC1ydWxlPSdldmVub2RkJyBjbGlwLXJ1bGU9J2V2ZW5vZGQnIGQ9J00yMyA0QzIzIDIuMzQzMTUgMjEuNjU2OSAxIDIwIDFINEMyLjM0MzE1IDEgMSAyLjM0MzE1IDEgNFYyMEMxIDIxLjY1NjkgMi4zNDMxNSAyMyA0IDIzSDIwQzIxLjY1NjkgMjMgMjMgMjEuNjU2OSAyMyAyMFY0Wk0yMSA0QzIxIDMuNDQ3NzIgMjAuNTUyMyAzIDIwIDNINEMzLjQ0NzcyIDMgMyAzLjQ0NzcyIDMgNFYyMEMzIDIwLjU1MjMgMy40NDc3MiAyMSA0IDIxSDIwQzIwLjU1MjMgMjEgMjEgMjAuNTUyMyAyMSAyMFY0WicgZmlsbD0nJTIzMEYwRjBGJy8lM0UlM0NwYXRoIGQ9J000LjgwNjY1IDE3LjUyMTFMOS4xMjIxIDkuNjA5NDdDOS41MDExMiA4LjkxNDYxIDEwLjQ5ODkgOC45MTQ2MSAxMC44Nzc5IDkuNjA5NDdMMTQuMDQ2NSAxNS40MTg2TDE1LjEzMTggMTMuNTE5NEMxNS41MTU3IDEyLjg0NzYgMTYuNDg0MyAxMi44NDc2IDE2Ljg2ODIgMTMuNTE5NEwxOS4xNDUxIDE3LjUwMzlDMTkuNTI2IDE4LjE3MDUgMTkuMDQ0NiAxOSAxOC4yNzY4IDE5SDUuNjg0NTRDNC45MjU0OCAxOSA0LjQ0MzE3IDE4LjE4NzUgNC44MDY2NSAxNy41MjExWicgZmlsbD0nJTIzMEYwRjBGJy8lM0UlM0NwYXRoIGQ9J00xOCA4QzE4IDkuMTA0NTcgMTcuMTA0NiAxMCAxNiAxMEMxNC44OTU0IDEwIDE0IDkuMTA0NTcgMTQgOEMxNCA2Ljg5NTQzIDE0Ljg5NTQgNiAxNiA2QzE3LjEwNDYgNiAxOCA2Ljg5NTQzIDE4IDhaJyBmaWxsPSclMjMwRjBGMEYnLyUzRSUzQy9zdmclM0U="))()) + ".bottomToolOptions_tracing select:empty " + JSON.stringify(O('display')('none !important')()).replaceAll(...L(/[+-\-]/g)(a => T(a == '-' || a == '+')(_ => a)(_ => String.fromCharCode(a.charCodeAt(0)+15)))()).replaceAll(...L(/(?<!\\)"/g)("")()).replaceAll(...L('\\')('')()) + ".bottomToolOptions_tracing select:empty ~ * " + JSON.stringify(O('display')('none !important')()).replaceAll(...L(/[+-\-]/g)(a => T(a == '-' || a == '+')(_ => a)(_ => String.fromCharCode(a.charCodeAt(0)+15)))()).replaceAll(...L(/(?<!\\)"/g)("")()).replaceAll(...L('\\')('')()))()))(T(h.draw.m)(H)(_ => q(h.draw = (d => _ => q(G())(d.call(h)))(h.draw))(h.draw.m = true)))(U(createjs.Ticker)('addEventListener')('tick')(_ => (c => (T(e && c != 'tracing')(_ => q(e = false)(F.classList.remove('active')))(_ => !e && c == 'tracing' && q(e = true)(F.classList.add('active')))))(h.toolHandler.currentTool))()))(new Proxy(...L(Function())(O('construct')(R(_ => ([s]) => (W => q(W.init(s))(W.toolUpdate = W.update)(W.images = [])(W.name = 'tracing')(W.opacity = 0.3)(W.down = false)(W.p = v()())(W.selected = undefined)(W.moved = false)(W.press = _ => q(W.p = W.mouse.touch.real)(W.down = true)(W.changed = false)(T(W.selected?.hoverPoint > -1)(H)(_ => (selected => selected != 'ret' && q(W.moved = false)(W.selected && (W.selected.selected = false))(W.selected = selected)(W.selected && (W.selected.selected = true)))(T(W.selected)(_ => T(W.moved && C(W.selected.untransformed(W.p))(v()())(v(W.selected.i.width * W.selected.scale.x)(W.selected.i.height * W.selected.scale.y)))(_ => (W.moved = false) || 'ret')(_ => [undefined].concat(W.images.slice(W.images.indexOf(W.selected) + 1)).concat(U(W.images)('slice')(0)(W.images.indexOf(W.selected) + 1)()).reduce(R(a => b => i => T(!a && C(b.untransformed(W.p))(v()())(v(b.i.width * b.scale.x)(b.i.height * b.scale.y)))(_ => W.setUICurrent((i + W.images.indexOf(W.selected)) % W.images.length) && b)(_ => a)))))(_ => [undefined].concat(W.images).reduce(R(a => b => i => T(!a && C(b.untransformed(W.p))(v()())(v(b.i.width * b.scale.x)(b.i.height * b.scale.y)))(_ => W.setUICurrent(i - 1) && b)(_ => a))))))))(W.hold = _ => q(W.p = W.mouse.touch.real)(T(W.selected)(_ => (N => (P => M => T(P.x || P.y)(_ => (E => (W.moved = true) && T(W.selected.hoverPoint < 8)(_ => (o => s => N => (a => (n => q(W.selected.scale.inc(N(n)(a)))(W.selected.pos.inc(N(N(n)(v(o.x < 0)(o.y < 0)))(s).factor(-1)))(W.selected.pos.inc(N(N(n)(o))(s).factor(Math.cos(W.selected.rot) / 2 - .5)))(W.selected.pos.inc(N(N(n)(v(-o.y)(o.x)))(v(s.y)(s.x)).factor(Math.sin(W.selected.rot) / 2))))(v((a => a.x + a.y)((a => b => v(a.x / b.x)(a.y / b.y))(N(E)(o))(s)) / (a.x + a.y))()))((a => v(Math.abs(a.x))(Math.abs(a.y)))(o)))(o[W.selected.hoverPoint])(v(W.selected.i.width)(W.selected.i.height))(a => b => v(a.x * b.x)(a.y * b.y)))(_ => T(W.selected.hoverPoint == 8)(_ => (W.selected.rot += E.x / (W.selected.i.height * W.selected.scale.y / 2 - M.y)))(_ => W.selected.pos.inc(P))))(M.sub(W.selected.untransformed(N))))(H))(W.p.sub(N))(W.selected.untransformed(W.p)))(W.mouse.touch.old.real))(H)))(W.release = _ => (W.down = false))(W.toggleVisibility = _ => (i => o => T(i.show)(_ => q(i.show = false)(i.selected && (W.moved = false))(o.innerText = '* ' + o.innerText) && 'Show')(_ => q(i.show = true)(o.innerText = o.innerText.substr(2)) && 'Hide'))(W.images[D.selectedIndex])(D.children[D.selectedIndex]))(W.removeCurrent = _ => (i => q(W.images[i].clean() && (W.selected = undefined))(U(W.images)('splice')(i)(1)())(D.removeChild(D.children[i]))(D.onchange()))(D.selectedIndex))(W.setUICurrent = a => q(D.selectedIndex = a)(D.onchange()))(W.update = _ => q(W.toolUpdate())(T(W.selected && !W.down)(_ => (W.selected.hoverPoint = (v => m => [undefined].concat(p(W.selected)).reduce(R(a => b => i => T(!(a+1) && C(m)(b.sub(v))(b.add(v)))(_ => i)(_ => a))) - 1)(v(5 / h.camera.zoom)())(W.selected.untransformed(W.mouse.touch.real))))(H))) && W)(new h.toolHandler.tools.straightline.__proto__.__proto__.constructor)))())())))(_ => q(d.images.forEach(j => q(T(j.ready && j.show)(_ => (i => (j.selected && i.update() && 0) || (pos => zoom => w => h => T(pos.x > g.canvas.width || pos.y > g.canvas.height || pos.x + i.i.width * zoom * i.scale.x < 0 || pos.y + i.i.height * zoom * i.scale.y < 0)(H)(_ => q(t.globalAlpha = j.opacity)(U(t)('setTransform')(zoom)(0)(0)(zoom)(pos.x + w * zoom)(pos.y + h * zoom)())(t.rotate(i.rot))(U(t)('drawImage')(i.i)(-w)(-h)(i.i.width * i.scale.x)(i.i.height * i.scale.y)()) && T(j.selected && e)(_ => q(t.strokeStyle = '#000000')(t.fillStyle = '#00ff00')(t.lineWidth = 2 / zoom)(t.globalAlpha = 0.5)(p(i).forEach(R(p => l => (k => q((l == j.hoverPoint) && U(t)('fillRect')(k.x - 5 / zoom)(k.y - 5 / zoom)(10 / zoom)(10 / zoom)())(U(t)('strokeRect')(k.x - 5 / zoom)(k.y - 5 / zoom)(10 / zoom)(10 / zoom)()))(p.sub(v(w)(h))))))((g.mod.getVar("pointDataAlways") || h.toolHandler.gamepad.isButtonDown("ctrl")) && (m => f => q(t.globalAlpha = 1)(U(t)('setTransform')(1)(0)(0)(1)(0)(0)())(t.strokeStyle = '#ffffff')(t.fillStyle = '#000000')(t.lineWidth = 2)(t.font = 'bold ' + (f - 5) + 'pt arial')(U(t)('strokeText')('(' + (j.pos.x | 0) + ' ~ ' + (j.pos.y | 0) + ')')(m.x)(m.y)())(U(t)('strokeText')('x(' + (Math.round(j.scale.x * 500) / 500) + ' ~ ' + (Math.round(j.scale.y * 500) / 500) + ')')(m.x)(m.y + f)())(U(t)('strokeText')(Math.round(j.scale.x * i.i.width) + 'x' + Math.round(j.scale.y * i.i.height))(m.x)(m.y + f * 2)())(U(t)('strokeText')((Math.round((((j.rot % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI)) * 1000) / 1000) + 'r')(m.x)(m.y + f * 3)())(U(t)('fillText')('(' + (j.pos.x | 0) + ' ~ ' + (j.pos.y | 0) + ')')(m.x)(m.y)())(U(t)('fillText')('x(' + (Math.round(j.scale.x * 500) / 500) + ' ~ ' + (Math.round(j.scale.y * 500) / 500) + ')')(m.x)(m.y + f)())(U(t)('fillText')(Math.round(j.scale.x * i.i.width) + 'x' + Math.round(j.scale.y * i.i.height))(m.x)(m.y + f * 2)())(U(t)('fillText')((Math.round((((j.rot % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI)) * 1000) / 1000) + 'r')(m.x)(m.y + f * 3)()))(p(i)[2].factor(zoom).add(v(10 + pos.x)(25 + pos.y)))(15 * g.pixelRatio)))(H)))(i.pos.toScreen(h))(h.camera.zoom)(i.i.width * i.scale.x / 2)(i.i.height * i.scale.y / 2))(j.actual))(H))))(U(t)('setTransform')(1)(0)(0)(1)(0)(0)())(t.globalAlpha = 1)))(c(O('tag')('div')('classes')(L('sideButton')('sideButton-bottom')('sideButton_tracingTool')())('onclick')(_ => q(GameManager.game.currentScene.toolHandler.setTool('tracing'))((btt => q(btt.firstElementChild.remove())(btt.insertBefore(...L(E)(btt.firstElementChild)())))(document.querySelector('.bottomMenu .clearfix'))))('oncreate')(e =>(s => new Promise(r => V(_ => (f => T(f)(_ => r(f))(H))(document.querySelector(s)))(250)))('.leftMenu').then(i =>q(i.lastElementChild.classList.remove('sideButton-bottom'))(i.appendChild(e))))('children')([O('tag')('span')('classes')(L('editorgui_icons')('editorgui_icons-icon_tracing')())()])())))(c(O('tag')('div')('classes')(L('bottomToolOptions')('bottomToolOptions_tracing')())('data')(O('reactid')('.0.4.0.0')())('children')([O('tag')('div')('classes')(['bottomToolOptions-toolTitle'])('children')(L(O('tag')('span')('classes')(L('editorgui_icons')('editorgui_icons-icon_tracing')())())(O('tag')('span')('classes')(['toolName'])('children')(L(O('tag')('span')('innerHTML')('Tracing : ')())(O('tag')('button')('innerHTML')('Import')('onclick')(e => q(e.target.nextElementSibling.click())(e.stopPropagation()))())(O('tag')('input')('type')('file')('accept')('image/*')('multiple')('true')('onchange')(e => (f => q(d.images.push(...f.map(i => new I(i))))(f.forEach(i => c(O('tag')('option')('parent')(D)('value')(i.name)('innerText')(i.name)()))))([...e.target.files]))('style')('display: none')())(D)(O('tag')('input')('type')('range')('min')('0')('max')('1')('step')('0.01')('onchange')(e => (d.images[D.selectedIndex].opacity = e.target.value))('value')(0.3)('style')('display: inline')())(O('tag')('button')('innerHTML')('Hide')('onclick')(e => (e.target.innerHTML = d.toggleVisibility()))())(O('tag')('button')('innerHTML')('Delete')('onclick')(_ => d.removeCurrent())())())())())()])())))(c(O('tag')('select')('oncreate')(D => (D.onchange = _ => q(D.parentElement.children[5].innerHTML = L('Show')('Hide')()[+d.images[D.selectedIndex].show])(D.parentElement.children[4].value = d.images[D.selectedIndex].opacity)))()))(new Proxy(...L(Function())(O('construct')(R(_ => ([f]) => (W => q(W.update = _ => q(W.actual.pos = W.actual.pos.add(W.pos.factor(4)).factor(.2))(W.actual.scale = W.actual.scale.add(W.scale.factor(4)).factor(.2))(W.actual.rot = (W.rot * 4 + W.actual.rot) / 5)(W.actual.size = W.actual.size.add(W.size.factor(4)).factor(.2)))(W.untransformed = a => (d => b => (c => v(c.x * Math.cos(-W.rot) - c.y * Math.sin(-W.rot))(c.x * Math.sin(-W.rot) + c.y * Math.cos(-W.rot)).add(b))(d.sub(b)))(a.sub(W.pos))(v(W.i.width * W.scale.x / 2)(W.i.height * W.scale.y / 2)))(W.clean = _ => URL.revokeObjectURL(W.i.src) || W.selected)(W.ready = false)(W.show = true)(W.i = new Image())(W.i.onload = _ => q(W.ready = true)(W.size = v(W.i.width)(W.i.height))(W.actual.i = W.i))(W.i.onerror = _ => console.log('loading failed!'))(W.i.src = URL.createObjectURL(f))(W.name = f.name)(W.pos = v()())(W.scale = v(1)())(W.rot = 0)(W.opacity = d.opacity)(W.selected = false)(W.hoverPoint = undefined)(W.size = v(W.i.width)(W.i.height))(W.actual = O('pos')(v()())('scale')(v(1)())('rot')(0)('size')(v(W.i.width)(W.i.height))('update')(W.update)('i')(W.i)())&& W)(Object())))())())))(L(0)(1)(2)(6)(10)(9)(8)(4)().map(i => v((i & 3) - 1)((i >> 2) - 1)))(i => (size => pos => L(pos)(pos.add(v(size.x / 2)(0)))(pos.add(v(size.x)(0)))(pos.add(v(size.x)(size.y / 2)))(pos.add(size))(pos.add(v(size.x / 2)(size.y)))(pos.add(v()(size.y)))(pos.add(v()(size.y / 2)))(pos.add(v(size.x / 2)(-20 / h.camera.zoom)))(pos.add(v(size.x / 2)(size.y / 2)))())(v(i.i.width * i.scale.x)(i.i.height * i.scale.y))(v()()))(y(h => p => (e => q(T(p.parent)(_ => p.parent.append(e))(H))(delete p.tag)(delete p.parent)(Object.keys(p).forEach(i => T(i == 'children')(_ => p[i].forEach(c => T(c instanceof HTMLElement)(_ => e.append(c))(_ => q(c.parent = e)(h(c)))))(_ => T(i == 'classes')(_ => e.classList.add(...p[i]))(_ => T(i == 'data')(_ => Object.keys(p[i]).forEach(j => (e.dataset[j] = p[i][j])))(_ => (e[i] = p[i]))))))(p.oncreate?.(e)) && e)(document.createElement(p.tag))))(p => a => b => (u => l => p.x >= u.x && p.x <= l.x && p.y >= u.y && p.y <= l.y)(v(u(Math.min)(a.x)(b.x)())(u(Math.min)(a.y)(b.y)()))(v(u(Math.max)(a.x)(b.x)())(u(Math.max)(a.y)(b.y)())))(Object()))((z => (x = 0) => (y = x) => z.add(O('x')(x)('y')(y)()))(h.camera.position.factor(0))))(g.currentScene)(g.canvas.getContext('2d')))(GameManager.game)(false)))(H))(250))(y(h => m => a => T(a != undefined)(_ => h(m.concat([a])))(_ => Object.fromEntries(m.reduce(R(a => b => i => T(i & 1)(_ => a.concat([[b]]))(_ => U(a)('with')(-1)([a.at(-1).concat([b])])()))))))([[]]))(f => t => (i => u(setInterval)(_ => f() && clearInterval(i + 1))(t)(clearInterval(i)))(u(setInterval)(H)(1000)()))(y(f => _ => f))(u(Array)))(y(h => m => (f => (a => T(a != undefined)(_ => h(m.concat(a))(f))(_ => f(...m)))))([]))(o => y(h => (m => (f => (a => T(a != undefined)(_ => h(m.concat(a))(f))(_ => o[f].call(...m))))))([o]))(y(h => f => (...a) => T(f instanceof Function)(_ => T(a.length)(_ => h(f(a[0]))(...a.slice(1)))(f))(_ => f))))(h => (x => h(x(x)))(y => h(a => y(y)(a))))(i => t => e => [e].concat(t)[+(!!i)]())(_ => _);
